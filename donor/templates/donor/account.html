{% extends 'base.html' %}
{% block title %}My Account{% endblock %}

{% block content %}
<div class="container">
  <div class="account-wrapper">
    <div class="profile-panel">
      <h2>Profile</h2>
      <p><strong>Username:</strong> {{ user.username }}</p>
      <p><strong>Email:</strong> {{ user.email }}</p>
      <p><strong>Contact:</strong> {{ user.phone_no }}</p>
      <div class="btn-group">
        <a href="{% url 'edit_profile' %}" class="btn">Edit Profile</a>
        <a href="#your-posts" id="managePostsBtn" class="btn btn-delete">Delete Post</a>
        <a href="{% url 'create_post' %}" class="btn btn-create">+ Create Post</a>
        <a href="{% url 'donation_requests' %}" class="btn">Requests</a>
      </div>
    </div>
    <div class="feed-panel">
      <h2 id="your-posts">Your Posts</h2>
      <div class="posts-grid">
        {% for post in donations %}
          <div class="post-card">
            {% if post.image %}<img src="{{ donation.image.url }}" alt="{{ post.title }}">{% endif %}
            <h3>{{ post.title }}</h3>
            <p>{{ post.description|truncatewords:20 }}</p>
            <small class="muted">{{ post.category }} | {{ donation.status }}</small>
            {% if post.is_requested and ClaimRequest %}
              <div class="btn-group">
                <button onclick="openPopup('{{ ClaimRequest.name }}', '{{ ClaimRequest.email }}', '{{ ClaimRequest.phone_no }}')" class="btn">View NGO</button>
                <a href="{% url 'accept_request' post.id %}" class="btn">Accept</a>
                <a href="{% url 'reject_request' post.id %}" class="btn">Reject</a>
              </div>
            {% endif %}
            <div class="btn-group">
              <a href="{% url 'edit_post' post.id %}" class="btn">Edit</a>
              <a href="{% url 'delete_post' post.id %}" class="btn">Delete</a>
            </div>
          </div>
        {% empty %}
          <p class="muted">No posts yet. Create one!</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- NGO info popup -->
  <div id="ngoPopup" class="popup" style="display:none;">
    <div class="popup-content">
      <h3>NGO Details</h3>
      <p id="ngoName"></p>
      <p id="ngoEmail"></p>
      <p id="ngoPhone"></p>
      <button onclick="closePopup()" class="btn">Close</button>
    </div>
  </div>

  <script>
  function openPopup(name, email, phone) {
    document.getElementById("ngoName").innerText = "Name: " + name;
    document.getElementById("ngoEmail").innerText = "Email: " + email;
    document.getElementById("ngoPhone").innerText = "Contact: " + (phone || 'N/A');
    document.getElementById("ngoPopup").style.display = "flex";
  }
  function closePopup() { document.getElementById("ngoPopup").style.display = "none"; }

  // Smooth scroll to posts and highlight delete links when 'Delete Post' clicked
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('managePostsBtn');
    if(btn){
      btn.addEventListener('click', function(e){
        e.preventDefault();
        var target = document.getElementById('your-posts');
        if(target){
          target.scrollIntoView({behavior:'smooth'});
          // briefly flash delete links
          var deletes = document.querySelectorAll('.posts-grid .btn-group a[href*="/delete/"]');
          deletes.forEach(function(d){ d.style.border = '2px solid #b33'; d.style.color = '#fff'; });
          setTimeout(function(){ deletes.forEach(function(d){ d.style.border=''; d.style.color=''; }); }, 3500);
        }
      });
    }
  });
  </script>
</div>
{% endblock %}